<!DOCTYPE>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	<meta http-equiv="expires" content="0">
	<title>THPower Cloud</title>
	<link href="../static/easyui/themes/default/easyui.css" rel="stylesheet" />
	<link href="../static/easyui/themes/icon.css" rel="stylesheet" />
	
	<script type="text/javascript" src="../static/easyui/jquery.min.js"></script>
	<script type="text/javascript" src="../static/easyui/jquery.easyui.min.js"></script>
	
	<script type="text/javascript" src="../main/public/thpowerutils.js"></script>
		
	<script type="text/javascript">

	//html打开时执行查询参数类别的信息
	$(function() {
		
		var IsCheckFlag=false;  //是否选中的标志
		var rowIndexTo=-1;      //保存当前保存的是那条数据
		
		//datagrid 初始化
		$('#dataGrid').datagrid({
		    height: 350,
		    //url: 'url',
		    method: 'POST',
		    //queryParams: { 'userid': userid },
		    idField: 'userId',
		    striped: true,
		    fitColumns: true,
		    singleSelect: true,
		    checkOnSelect: true,
		    selectOncheck: true,
		    rownumbers: true,
		    pagination: true,
		    nowrap: false,
		    pageSize: 10,
		    pageList: [10, 20, 50, 100, 150, 200],
		    showFooter: true,
		    columns: [[
		        { field: 'ck', checkbox: true },
		        { field: 'userId', title: '标记', width: 50, align: 'center', hidden:'true' },
		        { field: 'userRootId', title: '标记', width: 50, align: 'center', hidden:'true' },
		        { field: 'userName', title: '名称', width: 100, align: 'center',  },
		        { field: 'userEmail', title: '邮箱', width: 150, align: 'center' },
		        { field: 'userAge', title: '年龄', width: 80, align: 'center' },
		        { field: 'userSex', title: '性别', width: 80, formatter: userSexType, align: 'center' },
		        { field: 'userLevel', title: '权限', width: 80, formatter: isLevel, align: 'center' },
		        { field: 'userIsValid', title: '有效性', width: 80, formatter: isValid, align: 'center' },
		        { field: 'userNote', title: '备注', width: 150, align: 'center' }
		    ]],
		    onBeforeLoad: function (param) {
		    },
		    onLoadSuccess: function (data) {
		    	//easyui datagrid 去掉 全选checkbox
		    	$(".datagrid-header-check").html("");
		    },
		    onLoadError: function () {		        
		    },
		    onClickCell: function (rowIndex, field, value) {		        
		    },
		    onSelect: function (rowIndex, rowData) {
		    	//easyui datagrid 单选取消选中
				if(rowIndexTo==rowIndex && IsCheckFlag){
				    IsCheckFlag = false;
				    rowIndexTo = -1;
					 $('#dataGrid').datagrid("unselectRow",rowIndex);
				 }else{
					 IsCheckFlag = true;
					 rowIndexTo = rowIndex;
				 }
			}     
		});
		
		query();
		
	})
	
	//数据格式转换：int类型，展示时，需要转换为String类型
	function isLevel(value, row, index)
	{
		if(value==0)
		{
			return "超级账号";
		}else if(value==1)
		{
			return "管理账号";
		}else
		{
			return "普通账号";
		}
	}
	
	
	function isValid(value, row, index)
	{
		if(value==0)
		{
			return "否";
		}else if(value==1)
		{
			return "是";
		}else
		{
			return "?";
		}
	}
	
	function userSexType(value, row, index)
	{
		if(value==0)
		{
			return "女";
		}else if(value==1)
		{
			return "男";
		}else
		{
			return "?";
		}
	}
	
	//查询按钮
	function query() {
		
		var username = $('#username').val();
		
		$.ajax({
			type : 'POST',
			url : '/THPBuilder/getAllUsers',
			//contentType : 'application/json',
			data : {'username' : username},
			dataType : 'json',
			async : true,
			success : function(data, textStatus) {					
				//console.log(data);
				
				$("#dataGrid").datagrid("loadData", data.rows);  //动态取数据
				
			},
			error : function(XMLHttpRequest, textStatus, errorThrown) {
				console.log("请求失败，无法获取分组数据");
			}
		});
	}
	
	//new data
	function newItem()
	{
		$('#dlg').dialog('open').dialog('setTitle', '新增用户');
		$('#fm').form('clear');	
		
		url = "/THPBuilder/insertUser";
	}
	
	//edit data
	function editItem()
	{
		var row = $('#dataGrid').datagrid('getSelected');
		if (row){
			$('#dlg').dialog('open').dialog('setTitle','编辑用户');
			$('#fm').form('load', row);
			url = '/THPBuilder/updateUser?userId='+row.userId;
		}else
		{
			$.messager.show({
				title: '提示',
				msg: "请选中参数行！"
			});
		}
	}
	
	//delete data
	function deleteItem()
	{
		var row = $('#dataGrid').datagrid('getSelected');
		if (row){
			$.messager.confirm('确认','请确认,您要删除此用户吗？',function(r){
				if (r){
					$.post('/THPBuilder/deleteUser',{userId: row.userId},function(result){
						if (result.errorMsg){
							$.messager.show({
								title: 'Error',
								msg: result.errorMsg
							});
						} else {
							$('#dataGrid').datagrid('reload');	// reload the user data
						}
					},'json');
				}
			});
		}else
		{
			$.messager.show({
				title: '提示',
				msg: "请选中行！"
			});
		}
		
	}
	
	
	//init password for power12345
	function initUserPassword()
	{
		var row = $('#dataGrid').datagrid('getSelected');
		if (row){
			$.messager.confirm('确认','请确认,您要重置此用户密码吗？',function(r){
				if (r){
					$.post('/THPBuilder/initUserPassword',{userId: row.userId}, function(result){
						if (result.errorMsg){
							$.messager.show({
								title: 'Error',
								msg: result.errorMsg
							});
						} else {
							$('#dataGrid').datagrid('reload');	// reload the user data
							$.messager.show({
								title: 'Success',
								msg: '初始化成功，密码为：power12345'
							});
							
						}
					},'json');
				}
			});
		}else
		{
			$.messager.show({
				title: '提示',
				msg: "请选中行！"
			});
		}
		
	}
	
	
	
	
	//save data
	function saveItem(){
		$('#fm').form('submit',{
			url: url,
			onSubmit: function(){
				return $(this).form('validate');
			},
			success: function(result){
				var result = eval('('+result+')');
				if (result.errorMsg){
					$.messager.show({
						title: 'Error',
						msg: result.errorMsg
					});
				} else {
					$('#dlg').dialog('close');		// close the dialog
					$('#dataGrid').datagrid('reload');	// reload the user data
				}
			}
		});
	}
	
</script>
</head>
<body>
	<div>
	<b>用户：</b>
	<input id="username" type="text" style="width: 120px; height: 24px;" ></input>
	<a href="javascript:query();" class="easyui-linkbutton" iconCls="icon-search">查 询</a>
	</div>
	<table id="dataGrid" class="easyui-datagrid" style="width:100%;height:300px"
		toolbar="#toolbar" rownumbers="true" fitColumns="true" singleSelect="true">
        <thead>
            <tr></tr>
         </thead>
    </table>
    <div id="toolbar">
		<a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="newItem()">新增</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="editItem()">编辑</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="deleteItem()">删除</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-ok" plain="true" onclick="initUserPassword()">恢复密码</a>
	</div>
	
	<div id="dlg" class="easyui-dialog" style="width:300px;height:300px;padding:10px 20px"
		closed="true" buttons="#dlg-buttons">
	<div class="ftitle"></div>
	
	<form id="fm" method="post">
		<div class="fitem">
			<label>名   称:</label>
			<input name="userName" class="easyui-validatebox" required="true">
		</div>
		<div class="fitem">
			<label>邮   箱:</label>
			<input name="userEmail" class="easyui-validatebox" required="true,validType:'email'">
		</div>
		<div class="fitem">
			<label>年  龄:</label>
			<input name="userAge" type="text">
		</div>
		<div class="fitem">
			<label>性   别:</label>
			<select name="userSex" class="easyui-combobox" style="width:175px;">
			<option value=1>男</option>
			<option value=0>女</option>
			</select>
		</div>
		<div class="fitem">
			<label>权  限:</label>
			<select name="userLevel" class="easyui-combobox" style="width:175px;">
			<option value=0>超级账号</option>
			<option value=1>管理账号</option>
			<option value=2 checked>普通账号</option>
			</select>
		</div>
		<div class="fitem">
			<label>有  效:</label>
			<select name="userIsValid" class="easyui-combobox" style="width:175px;">
			<option value=1>是</option>
			<option value=0>否</option>
			</select>
		</div>
		<div class="fitem">
			<label>备   注:</label>
			<input name="userNote">
		</div>
	</form>
	</div>
	<div id="dlg-buttons">
		<a href="#" class="easyui-linkbutton" iconCls="icon-ok" onclick="saveItem();">保存</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')">取消</a>
	</div>
</body>
</html>